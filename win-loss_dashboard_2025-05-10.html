<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"="width=device-width, initial-scale=1.0">
    <title>CMRP Win/Loss Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        /* --- Theme Variables --- */
        :root {
            /* Light Theme Variables */
            --bg-body: #f9fafb; --text-body: #1f2937; --bg-container: #ffffff; --border-container: #e5e7eb; --text-title: #111827; --text-label: #4b5563; --border-table: #e5e7eb; --bg-header: #f3f4f6; --text-header: #6b7280; --bg-row: #ffffff; --text-row: #374151; --bg-row-hover: #f3f4f6; --bg-op100: #dcfce7; --text-op100: #166534; --bg-op100-hover: #bbf7d0; --bg-lost: #fee2e2; --text-lost: #991b1b; --bg-lost-hover: #fecaca; --bg-declined: #e5e7eb; --text-declined: #4b5563; --bg-declined-hover: #d1d5db; --border-urgent-soon: #f59e0b; --border-urgent-past: #ef4444; --bg-control: #ffffff; --border-control: #d1d5db; --text-control: #111827; --placeholder-control: #9ca3af; --bg-control-hover: #f9fafb; --border-focus: #3b82f6; --shadow-focus: rgba(59, 130, 246, 0.3); --text-secondary: #6b7280; --text-error: #dc2626; --text-link: #3b82f6; --text-link-hover: #2563eb;
            --select-arrow-url: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            --bg-modal: #ffffff; --border-modal: #e5e7eb; --text-modal-title: #111827; --bg-modal-close-hover: #e5e7eb; --bg-modal-save: #3b82f6; --text-modal-save: #ffffff; --bg-modal-save-hover: #2563eb; --bg-theme-button: #e5e7eb; --text-theme-button: #1f2937; --border-theme-button: #d1d5db; --bg-theme-button-hover: #d1d5db; --bg-filter-button: #e5e7eb; --text-filter-button: #374151; --border-filter-button: #d1d5db; --bg-filter-button-hover: #d1d5db; --bg-filter-button-active: #4f46e5; --text-filter-button-active: #ffffff; --border-filter-button-active: #4f46e5;
            /* Chart specific */
            --chart-grid-color: rgba(0, 0, 0, 0.1); --chart-tick-color: #666; --chart-title-color: #333; --chart-legend-color: #333; --chart-tooltip-bg: rgba(0, 0, 0, 0.8); --chart-tooltip-text: #fff;
            /* Colors for Win/Loss */
            --color-loss: #ef4444; --color-loss-bg: rgba(239, 68, 68, 0.7);
            --color-win: #10b981; --color-win-bg: rgba(16, 185, 129, 0.7);
            --color-win-cost: #3b82f6; --color-win-cost-bg: rgba(59, 130, 246, 0.7);
            --color-loss-cost: #f97316; --color-loss-cost-bg: rgba(249, 115, 22, 0.7);
        }
        .dark {
            /* Dark Theme Variables */
             --bg-body: #1e1e1e; --text-body: #e0e0e0; --bg-container: #2d2d2d; --border-container: #404040; --text-title: #ffffff; --text-label: #c0c0c0; --border-table: #4a4a4a; --bg-header: #1a1a1a; --text-header: #a0a0a0; --bg-row: #2d2d2d; --text-row: #e0e0e0; --bg-row-hover: #3c3c3c; --bg-op100: #14532d; --text-op100: #dcfce7; --bg-op100-hover: #166534; --bg-lost: #7f1d1d; --text-lost: #fee2e2; --bg-lost-hover: #991b1b; --bg-declined: #4b5563; --text-declined: #bdc3c7; --bg-declined-hover: #525f70; --border-urgent-soon: #f97316; --border-urgent-past: #dc2626; --bg-control: #3c3c3c; --border-control: #5a5a5a; --text-control: #e0e0e0; --placeholder-control: #8e8e93; --bg-control-hover: #4a4a4a; --border-focus: #0a84ff; --shadow-focus: rgba(10, 132, 255, 0.3); --text-secondary: #a0a0a0; --text-error: #ff8080; --text-link: #8ab4f8; --text-link-hover: #a7c7fa;
             --select-arrow-url: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%23a0a0a0' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
             --bg-modal: #2d2d2d; --border-modal: #404040; --text-modal-title: #ffffff; --bg-modal-close-hover: #6b6b6b; --bg-modal-save: #4f46e5; --text-modal-save: #ffffff; --bg-modal-save-hover: #4338ca; --bg-theme-button: #4b5563; --text-theme-button: #f9fafb; --border-theme-button: #6b7280; --bg-theme-button-hover: #6b7280; --bg-filter-button: #374151; --text-filter-button: #d1d5db; --border-filter-button: #4b5563; --bg-filter-button-hover: #4b5563; --bg-filter-button-active: #6366f1; --text-filter-button-active: #ffffff; --border-filter-button-active: #6366f1;
             /* Chart specific */
            --chart-grid-color: rgba(255, 255, 255, 0.2); --chart-tick-color: #9ca3af; --chart-title-color: #f9fafb; --chart-legend-color: #f9fafb; --chart-tooltip-bg: rgba(255, 255, 255, 0.9); --chart-tooltip-text: #1f2937;
             /* Colors for Win/Loss */
            --color-loss: #f87171; --color-loss-bg: rgba(248, 113, 113, 0.7);
            --color-win: #34d399; --color-win-bg: rgba(52, 211, 153, 0.7);
            --color-win-cost: #8ab4f8; --color-win-cost-bg: rgba(138, 180, 248, 0.7);
             --color-loss-cost: #fdba74; --color-loss-cost-bg: rgba(253, 186, 116, 0.7);
        }

        /* Base Styles */
        body { background-color: var(--bg-body); color: var(--text-body); transition: background-color 0.3s, color 0.3s; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol"; }
        .main-container { background-color: var(--bg-container); border-color: var(--border-container); }
        h1, h3 { color: var(--text-title); }
        .dashboard-card { background-color: var(--bg-container); border: 1px solid var(--border-container); border-radius: 0.5rem; padding: 1rem 1.5rem; text-align: center; box-shadow: 0 1px 3px 0 rgba(0,0,0,0.1), 0 1px 2px 0 rgba(0,0,0,0.06); flex: 1; min-width: 150px; }
        .dashboard-title { color: var(--text-secondary); font-size: 0.75rem; margin-bottom: 0.25rem; text-transform: uppercase; letter-spacing: 0.05em; }
        .dashboard-value { color: var(--text-title); font-size: 1.875rem; font-weight: 600; line-height: 1.3; }
        .chart-section-container { background-color: var(--bg-container); border-radius: 0.5rem; box-shadow: 0 1px 3px 0 rgba(0,0,0,0.1), 0 1px 2px 0 rgba(0,0,0,0.06); }
        /* Form Controls (for filter dropdown) */
        select.filter-dropdown { appearance: none; background-position: right 0.5rem center; background-repeat: no-repeat; background-size: 1.5em 1.5em; padding-right: 2.5rem; min-width: 150px; background-image: var(--select-arrow-url); background-color: var(--bg-control); border-color: var(--border-control); color: var(--text-control); border-width: 1px; }
        select.filter-dropdown:focus { outline: none; border-color: var(--border-focus); box-shadow: 0 0 0 3px var(--shadow-focus); }
        select.filter-dropdown option { background-color: var(--bg-control); color: var(--text-control); }
        /* Ensure buttons use theme colors */
        .theme-button { background-color: var(--bg-theme-button); color: var(--text-theme-button); border: 1.5px solid var(--border-theme-button); transition: background 0.18s, color 0.18s, border-color 0.18s, box-shadow 0.18s; box-shadow: 0 2px 8px 0 rgba(59,130,246,0.06); }
        .theme-button:hover, .theme-button:focus { background-color: var(--bg-theme-button-hover); box-shadow: 0 4px 16px 0 rgba(59,130,246,0.10); }
        .link-button { background-color: var(--bg-modal-save); color: var(--text-modal-save); transition: filter 0.2s; }
        .link-button:hover { filter: brightness(90%); }
         /* Explicit height for chart wrapper */
         .chart-wrapper { position: relative; height: 400px; width: 100%; }
        .dashboard-table th.project-name-cell, .dashboard-table td.project-name-cell {
            max-width: 300px;
            min-width: 120px;
            white-space: normal;
            word-break: break-word;
            text-align: left;
        }
        .dashboard-table th, .dashboard-table td {
            /* Use theme variables for consistency */
            background-color: var(--bg-row);
            color: var(--text-row);
            border-bottom: 1px solid var(--border-table);
        }
        .dashboard-table th {
            background-color: var(--bg-header);
            color: var(--text-header);
        }
        .dashboard-table tr:hover td {
            background-color: var(--bg-row-hover);
        }
        .filter-button.table-status-btn {
            border: 1px solid var(--border-table);
            background-color: var(--bg-filter-button);
            color: var(--text-filter-button);
            transition: background-color 0.2s, color 0.2s, border-color 0.2s;
        }
        .filter-button.table-status-btn.active {
            background-color: var(--bg-filter-button-active);
            color: var(--text-filter-button-active);
            border-color: var(--border-filter-button-active);
            font-weight: 600;
        }
        .filter-button.table-status-btn:hover {
            background-color: var(--bg-filter-button-hover);
        }
        .simple-header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            width: 100%;
            z-index: 100;
            box-shadow: 0 2px 8px 0 rgba(0,0,0,0.08);
            background: var(--bg-header);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 2rem;
            min-height: 3.5rem;
            gap: 1.5rem;
        }
        .main-content {
            margin-top: 4.5rem;
        }
        .nav-square-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 44px;
            height: 44px;
            border-radius: 0.75rem;
            background: var(--bg-theme-button);
            color: var(--text-theme-button);
            border: 1.5px solid var(--border-theme-button);
            font-size: 1.6rem;
            transition: background 0.18s, color 0.18s, border-color 0.18s, box-shadow 0.18s;
            box-shadow: 0 2px 8px 0 rgba(59,130,246,0.06);
            margin: 0;
            padding: 0;
        }
        .nav-square-btn:hover, .nav-square-btn:focus {
            background: var(--bg-theme-button-hover);
            color: var(--text-theme-button);
            box-shadow: 0 4px 16px 0 rgba(59,130,246,0.10);
            outline: none;
        }
        .nav-square-btn.active, .nav-square-btn.bg-blue-600 {
            background: #6366f1;
            color: #fff !important;
            border-color: #6366f1;
            cursor: default;
            pointer-events: none;
        }
        .nav-square-btn .material-icons {
            font-size: 1.7rem;
        }
        .dark .nav-square-btn.active {
            background: #6366f1;
            color: #fff !important;
            border-color: #6366f1;
        }
        .dark .nav-square-btn:hover:not(.active) {
            background: #6b7280;
            color: #fff;
        }
    </style>
</head>
<body>
    <div class="simple-header">
        <div class="title-group">
            <img id="cmrpLogo" src="Logo/CMRP Logo Light.svg" alt="CMRP Logo" style="height:2.2rem;width:auto;display:inline-block;vertical-align:middle;transition:filter 0.2s;" />
            <span class="subtitle">Win-Loss Dashboard</span>
        </div>
        <div class="flex items-center gap-2">
            <nav class="flex gap-2">
                <a href="index.html" class="nav-square-btn" title="Opportunities"><span class="material-icons">dashboard</span></a>
                <a href="win-loss_dashboard.html" class="nav-square-btn active" title="Win-Loss Dashboard"><span class="material-icons">line_axis</span></a>
                <a href="forecastr_dashboard.html" class="nav-square-btn" title="Forecast Dashboard"><span class="material-icons">insights</span></a>
                <a href="user_management.html" class="nav-square-btn" title="User Management"><span class="material-icons">group</span></a>
            </nav>
            <button id="themeToggle" class="nav-square-btn" title="Toggle Theme"><span class="material-icons">light_mode</span></button>
        </div>
    </div>
    <div class="main-content">
        <div class="main-container container mx-auto p-6 rounded-lg shadow-md">
            <div class="flex flex-wrap gap-4 items-center mb-6" id="filterBar">
                <div>
                    <label for="solutionFilter" class="text-sm font-medium mr-1">Solution:</label>
                    <select id="solutionFilter" class="filter-dropdown p-1 text-xs rounded border">
                        <option value="all">All Solutions</option>
                    </select>
                </div>
                <div>
                    <label for="accountMgrFilter" class="text-sm font-medium mr-1">Account Mgr:</label>
                    <select id="accountMgrFilter" class="filter-dropdown p-1 text-xs rounded border">
                        <option value="all">All</option>
                    </select>
                </div>
                <div>
                    <label for="clientFilter" class="text-sm font-medium mr-1">Client:</label>
                    <select id="clientFilter" class="filter-dropdown p-1 text-xs rounded border">
                        <option value="all">All</option>
                    </select>
                </div>
            </div>

            <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                <div class="dashboard-card">
                    <div id="op100-total-count-title" class="dashboard-title">Total OP100 Count</div>
                    <div id="op100-total-count" class="dashboard-value">0</div>
                </div>
                <div class="dashboard-card">
                     <div id="op100-total-amount-title" class="dashboard-title">Total OP100 Amount</div>
                    <div id="op100-total-amount" class="dashboard-value">₱0</div>
                </div>
                 <div class="dashboard-card">
                    <div id="loss-total-count-title" class="dashboard-title">Total Loss Count</div>
                    <div id="loss-total-count" class="dashboard-value">0</div>
                </div>
                <div class="dashboard-card">
                     <div id="loss-total-amount-title" class="dashboard-title">Total Loss Amount</div>
                    <div id="loss-total-amount" class="dashboard-value">₱0</div>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-8">
                <div class="chart-section-container p-6">
                    <h3 class="text-lg font-semibold mb-4">Monthly Wins (OP100)</h3>
                    <div class="chart-wrapper">
                        <canvas id="winMonthlyChart"></canvas>
                    </div>
                </div>
                <div class="chart-section-container p-6">
                    <h3 class="text-lg font-semibold mb-4">Monthly Losses</h3>
                    <div class="chart-wrapper">
                        <canvas id="lossMonthlyChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Opportunities Table Section -->
            <div class="mt-10">
                <h3 class="text-lg font-semibold mb-4">Opportunities List</h3>
                <div class="flex flex-wrap gap-2 mb-2">
                    <button id="filterOP100Btn" class="filter-button table-status-btn px-3 py-1 rounded text-xs">OP100</button>
                    <button id="filterLOSTBtn" class="filter-button table-status-btn px-3 py-1 rounded text-xs">LOST</button>
                    <button id="filterAllBtn" class="filter-button table-status-btn px-3 py-1 rounded text-xs active">All</button>
                </div>
                <div class="overflow-x-auto rounded-lg border border-gray-200 dark:border-gray-700">
                    <table id="opportunitiesTable" class="min-w-full divide-y divide-gray-200 dark:divide-gray-700 dashboard-table">
                        <thead class="bg-gray-100 dark:bg-gray-800">
                            <tr>
                                <th class="project-name-cell px-4 py-2 text-left text-xs font-semibold">Project Name</th>
                                <th class="px-4 py-2 text-left text-xs font-semibold">Client</th>
                                <th class="px-4 py-2 text-left text-xs font-semibold">Account Mgr</th>
                                <th class="px-4 py-2 text-left text-xs font-semibold">Date Awarded</th>
                                <th class="px-4 py-2 text-right text-xs font-semibold">Final Amt</th>
                                <th class="px-4 py-2 text-right text-xs font-semibold">Margin</th>
                            </tr>
                        </thead>
                        <tbody id="opportunitiesTableBody" class="bg-white dark:bg-gray-900">
                            <!-- Rows will be inserted here -->
                        </tbody>
                    </table>
                </div>
            </div>

            </div>

        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        <script>
        // --- Global Variables ---
        let dashboardDataCache = null; // Cache fetched data (includes ALL opportunities)
        let winChartInstance = null;   // Instance for the Wins chart
        let lossChartInstance = null;  // Instance for the Losses chart
        let currentSolutionFilter = 'all'; // State for the solution filter

        // *** DOM elements for card titles and values ***
        let op100CountTitleElement = null;
        let op100AmountTitleElement = null;
        let op100CountValueElement = null;
        let op100AmountValueElement = null;
        let lossCountTitleElement = null;
        let lossAmountTitleElement = null;
        let lossCountValueElement = null;
        let lossAmountValueElement = null;

        // --- Helper Functions ---
        async function fetchDashboardData() {
            // Fetch data only once if not already cached
            if (dashboardDataCache) {
                return dashboardDataCache;
            }
            try {
                // Fetch from the updated endpoint that returns all data + unique solutions
                const res = await fetch('/api/dashboard');
                if (!res.ok) {
                    throw new Error(`HTTP error! status: ${res.status}`);
                }
                dashboardDataCache = await res.json(); // Store the full dataset
                console.log("Fetched Dashboard Data:", dashboardDataCache);
                // Add default empty arrays if needed (though backend should handle this)
                if (!dashboardDataCache.opportunities) dashboardDataCache.opportunities = [];
                if (!dashboardDataCache.uniqueSolutions) dashboardDataCache.uniqueSolutions = [];
                return dashboardDataCache;
            } catch (error) {
                console.error("Failed to fetch dashboard data:", error);
                return null; // Indicate failure
            }
        }

        function formatCurrency(num) {
            const number = Number(num);
            if (isNaN(number)) return '₱0.00';
            return '₱' + number.toLocaleString('en-PH', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }

        function formatMargin(value) {
            if (typeof value === 'string' && value.includes('%')) {
                return value; // Already formatted
            }
            const num = parseFloat(value);
            if (isNaN(num)) {
                return value || '';
            }
            if (num !== 0 && Math.abs(num) < 1) {
                return Math.round(num * 100) + '%';
            }
            return Math.round(num) + '%';
        }

         // --- Helper Functions (Copied from server.js for client-side use) ---
         function getColumnInsensitive(obj, target) {
            if (!obj || typeof obj !== 'object') return null;
            // MODIFIED: Added hyphen to the regex to also remove hyphens during normalization
            const norm = s => (s || '').toLowerCase().replace(/[\s_-]/g, '');
            const targetNorm = norm(target);
            for (const key of Object.keys(obj)) { if (norm(key) === targetNorm) return key; }
            return null;
        }
        // *** UPDATED: robustParseDate on Client-Side ***
        function robustParseDate(val) {
            if (!val) return null;
            // 1. Try direct parsing (handles ISO 8601 like '2025-01-31T16:00:00.000Z')
            let d = new Date(val);
            if (!isNaN(d)) {
                // --- FIX: If input is YYYY-MM-DD, parse as local date to avoid UTC shift ---
                if (typeof val === 'string' && /^\d{4}-\d{2}-\d{2}$/.test(val.trim())) {
                    const [year, month, day] = val.trim().split('-').map(Number);
                    return new Date(year, month - 1, day);
                }
                // If input is ISO string with time, use as-is (local time)
                return d;
            }

            // Keep other parsing attempts as fallbacks if direct parsing fails
            if (typeof val === 'number' && val > 25569) { try { const utc_days = val - 25569; const utc_milliseconds = utc_days * 86400 * 1000; const date_info = new Date(utc_milliseconds); if (!isNaN(date_info)) { return new Date(Date.UTC(date_info.getUTCFullYear(), date_info.getUTCMonth(), date_info.getUTCDate())); } } catch (e) { console.warn("Error parsing potential Excel date number:", val, e); } }
            if (typeof val !== 'string') return null;
            const trimmedVal = val.trim();
            // --- FIX: Parse YYYY-MM-DD as UTC ---
            if (trimmedVal.match(/^\d{4}-\d{1,2}-\d{1,2}$/)) { // Matches YYYY-MM-DD
                d = new Date(trimmedVal + 'T00:00:00Z'); // Append Z to ensure UTC interpretation
                if (!isNaN(d)) return d;
            }
            if (trimmedVal.match(/^\d{1,2}\/\d{1,2}\/\d{4}$/)) { const [m, d1, y] = trimmedVal.split('/').map(Number); if (m >= 1 && m <= 12 && d1 >= 1 && d1 <= 31) { d = new Date(Date.UTC(y, m - 1, d1)); if (!isNaN(d) && d.getUTCFullYear() === y && d.getUTCMonth() === m - 1 && d.getUTCDate() === d1) return d; } }
            if (trimmedVal.match(/^\d{1,2}\/\d{1,2}\/\d{4}$/)) { const [d1, m, y] = trimmedVal.split('/').map(Number); if (d1 > 12 && m >= 1 && m <= 12 && d1 >= 1 && d1 <= 31) { d = new Date(Date.UTC(y, m - 1, d1)); if (!isNaN(d) && d.getUTCFullYear() === y && d.getUTCMonth() === m - 1 && d.getUTCDate() === d1) return d; } }
            if (trimmedVal.match(/^\d{4}\/\d{1,2}\/\d{1,2}$/)) { const [y, m, d1] = trimmedVal.split('/').map(Number); if (m >= 1 && m <= 12 && d1 >= 1 && d1 <= 31) { d = new Date(Date.UTC(y, m - 1, d1)); if (!isNaN(d) && d.getUTCFullYear() === y && d.getUTCMonth() === m - 1 && d.getUTCDate() === d1) return d; } }
            if (trimmedVal.match(/^[A-Za-z]{3},\s[A-Za-z]{3}-\d{1,2}$/)) { const currentYear = new Date().getUTCFullYear(); const timestamp = Date.parse(`${trimmedVal.split(', ')[1]} ${currentYear} 00:00:00 GMT`); if (!isNaN(timestamp)) { d = new Date(timestamp); return new Date(Date.UTC(d.getUTCFullYear(), d.getUTCMonth(), d.getUTCDate())); } }
            if (trimmedVal.match(/^[A-Za-z]{3}-\d{1,2}$/)) { const currentYear = new Date().getUTCFullYear(); const timestamp = Date.parse(`${trimmedVal} ${currentYear} 00:00:00 GMT`); if (!isNaN(timestamp)) { d = new Date(timestamp); return new Date(Date.UTC(d.getUTCFullYear(), d.getUTCMonth(), d.getUTCDate())); } }
            return null; // Return null if all parsing attempts fail
         }
         // *** UPDATED: formatMonthYear to use UTC methods ***
         function formatMonthYear(date) {
            if (!(date instanceof Date) || isNaN(date)) { return 'Invalid Date'; }
            // Use local methods to avoid UTC shift issues
            const year = date.getFullYear();
            const month = date.toLocaleDateString('en-US', { month: 'long' });
            return `${month} ${year}`;
         }
         function parseCurrency(value) { /* ... keep parseCurrency function ... */
            if (typeof value === 'number') return value;
            if (typeof value === 'string') { const cleanedValue = value.replace(/[₱,]/g, '').trim(); if (cleanedValue.startsWith('(') && cleanedValue.endsWith(')')) { return parseFloat(cleanedValue.replace(/[()]/g, '')) * -1 || 0; } return parseFloat(cleanedValue) || 0; }
            return 0;
         }
        // --- End Helper Functions ---

        // Shift date by +1 month for chart labels
        function formatMonthYearShifted(date) {
            if (!(date instanceof Date) || isNaN(date)) return 'Invalid Date';
            // Add 1 month
            let year = date.getUTCFullYear();
            let month = date.getUTCMonth() + 1; // 0-based, so +1
            if (month > 11) { year += 1; month = 0; } // wrap to next year
            else { /* month is now 1-12, but Date expects 0-11 */ }
            const shiftedDate = new Date(Date.UTC(year, month, 1));
            return shiftedDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric', timeZone: 'UTC' });
        }

        // *** ADDED: Function to filter data and calculate summaries client-side ***
        function filterAndSummarizeData(allData, solutionFilter) {
            if (!allData || !allData.opportunities) {
                console.warn("filterAndSummarizeData called with invalid data.");
                return { // Return empty structure
                    totalOp100Count: 0, totalOp100Amount: 0, op100CurrentMonthCount: 0, op100CurrentMonthAmount: 0,
                    op100MonthlySummary: [], totalLossCount: 0, totalLossAmount: 0, opLossMonthlySummary: [],
                    uniqueSolutions: allData?.uniqueSolutions || [] // Keep solutions if available
                };
            }

            // Filter based on solution
            // *** Use the correct column name 'solutions' from the backend response ***
            const solutionKey = 'solutions'; // Use the exact key from the fetched data
            const filteredOpportunities = (solutionFilter && solutionFilter !== 'all' && solutionKey)
                ? allData.opportunities.filter(opp => opp[solutionKey] === solutionFilter)
                : allData.opportunities; // Use all if no filter, filter is 'all', or key not found

            // Calculate summaries based on filtered data using the copied/adapted logic
            const summaries = calculateWinLossDashboardData_ClientSide(filteredOpportunities); // Use client-side version

            // Return combined object
            return {
                ...summaries, // Includes calculated totals and monthly summaries
                uniqueSolutions: allData.uniqueSolutions // Pass through unique solutions for dropdown
            };
        }

        // *** UPDATED: Client-side version of the summary calculation logic with logging ***
        function calculateWinLossDashboardData_ClientSide(filteredOpportunities) {
            console.log(`[Client] Calculating summaries for ${filteredOpportunities?.length ?? 0} opportunities.`); // Log start of calculation
            const now = new Date();
            const currentUTCMonth = now.getUTCMonth();
            const currentUTCYear = now.getUTCFullYear();
            let op100Total = 0, op100TotalAmount = 0, op100CurrentMonthCount = 0, op100CurrentMonthAmount = 0, totalLossCount = 0, totalLossAmount = 0;
            const op100Monthly = {}, opLossMonthly = {};

            if (!filteredOpportunities || !Array.isArray(filteredOpportunities)) {
                filteredOpportunities = [];
            }

            filteredOpportunities.forEach((opp, index) => { // Added index for logging
                if (typeof opp !== 'object' || opp === null) return;
                // *** Use correct lowercase column names based on logs/hints ***
                const statusKey = 'opp_status'; // Use exact key from fetched data
                let dateKey = 'date_awarded_lost'; // Use exact key
                const amtKey = 'final_amt'; // Use exact key
                const status = opp[statusKey] ? String(opp[statusKey]).trim().toUpperCase() : 'UNKNOWN_STATUS';
                const dateValue = opp[dateKey] || null;
                const finalAmt = opp[amtKey] ? parseCurrency(opp[amtKey]) : 0;

                // *** Add logging for date parsing ***
                let parsedDate = robustParseDate(dateValue); // Use updated parser
                let monthYear = 'Unknown Month';
                if (parsedDate && !isNaN(parsedDate)) {
                     monthYear = formatMonthYear(parsedDate); // <-- Use non-shifted label
                     // console.log(`[Client Calc index ${index}] Parsed date '${dateValue}' to ${monthYear}`); // Optional: Log successful parse
                 } else if ((status === 'OP100' || status === 'LOST') && dateValue) { // Log only if relevant status and date has a value
                     console.warn(`[Client Calc index ${index}] Failed to parse date '${dateValue}' for status ${status}. Grouping as '${monthYear}'.`);
                 }
                 // *** End logging ***

                if (status === 'OP100') {
                    op100Total++; op100TotalAmount += finalAmt;
                    if (!op100Monthly[monthYear]) op100Monthly[monthYear] = { count: 0, totalAmount: 0 };
                    op100Monthly[monthYear].count++; op100Monthly[monthYear].totalAmount += finalAmt;
                    // *** Use UTC month/year for current month check ***
                    if (parsedDate && parsedDate.getUTCMonth() === currentUTCMonth && parsedDate.getUTCFullYear() === currentUTCYear) {
                        op100CurrentMonthCount++; op100CurrentMonthAmount += finalAmt;
                    }
                } else if (status === 'LOST') {
                    totalLossCount++; totalLossAmount += finalAmt;
                    if (!opLossMonthly[monthYear]) opLossMonthly[monthYear] = { count: 0, totalAmount: 0 };
                    opLossMonthly[monthYear].count++; opLossMonthly[monthYear].totalAmount += finalAmt;
                }
            });

            const createMonthlySummary = (monthlyData) => {
                const sortedMonths = Object.keys(monthlyData)
                    .filter(m => m !== 'Unknown Month' && m !== 'Invalid Date' && !isNaN(new Date(m))) // Ensure month can be parsed for sorting
                    .sort((a, b) => new Date(a) - new Date(b)); // Sort by date
                // Add Unknown/Invalid month back if it has data
                if (monthlyData['Unknown Month'] && (monthlyData['Unknown Month'].count > 0 || monthlyData['Unknown Month'].totalAmount > 0)) sortedMonths.push('Unknown Month');
                if (monthlyData['Invalid Date'] && (monthlyData['Invalid Date'].count > 0 || monthlyData['Invalid Date'].totalAmount > 0)) sortedMonths.push('Invalid Date');
                return sortedMonths.map(monthYear => ({ monthYear, count: monthlyData[monthYear]?.count || 0, totalAmount: monthlyData[monthYear]?.totalAmount || 0 }));
            };
            const op100MonthlySummary = createMonthlySummary(op100Monthly);
            const opLossMonthlySummary = createMonthlySummary(opLossMonthly);

            // Log the generated summaries
            console.log("[Client Calc] OP100 Summary:", op100MonthlySummary);
            console.log("[Client Calc] Loss Summary:", opLossMonthlySummary);


            // *** FIX: Correct property name in return object ***
            return {
                totalOp100Count: op100Total,
                totalOp100Amount: op100TotalAmount, // Corrected: Explicit assignment
                op100CurrentMonthCount,
                op100CurrentMonthAmount,
                op100MonthlySummary,
                totalLossCount,
                totalLossAmount,
                opLossMonthlySummary
            };
        }


        // *** UPDATED: Function to update ALL summary card titles and values ***
        function updateSummaryCards(data) {
            // Ensure elements are fetched
            if (!op100CountValueElement) op100CountValueElement = document.getElementById('op100-total-count');
            if (!op100AmountValueElement) op100AmountValueElement = document.getElementById('op100-total-amount');
            if (!lossCountValueElement) lossCountValueElement = document.getElementById('loss-total-count');
            if (!lossAmountValueElement) lossAmountValueElement = document.getElementById('loss-total-amount');
            if (!op100CountTitleElement) op100CountTitleElement = document.getElementById('op100-total-count-title');
            if (!op100AmountTitleElement) op100AmountTitleElement = document.getElementById('op100-total-amount-title');
            if (!lossCountTitleElement) lossCountTitleElement = document.getElementById('loss-total-count-title');
            if (!lossAmountTitleElement) lossAmountTitleElement = document.getElementById('loss-total-amount-title');

            // Set titles based on filter
            const filterText = currentSolutionFilter === 'all' ? '' : ` (${currentSolutionFilter})`; // Add filter text
            if (op100CountTitleElement) op100CountTitleElement.textContent = `Total OP100 Count${filterText}`;
            if (op100AmountTitleElement) op100AmountTitleElement.textContent = `Total OP100 Amount${filterText}`;
            if (lossCountTitleElement) lossCountTitleElement.textContent = `Total Loss Count${filterText}`;
            if (lossAmountTitleElement) lossAmountTitleElement.textContent = `Total Loss Amount${filterText}`;

            // Use calculated totals from the (potentially filtered) data object
            const totalOp100Count = data?.totalOp100Count ?? 0;
            const totalOp100Amount = data?.totalOp100Amount ?? 0;
            const totalLossCount = data?.totalLossCount ?? 0;
            const totalLossAmount = data?.totalLossAmount ?? 0;

            // Update values
            if (op100CountValueElement) op100CountValueElement.textContent = totalOp100Count;
            if (op100AmountValueElement) op100AmountValueElement.textContent = formatCurrency(totalOp100Amount);
            if (lossCountValueElement) lossCountValueElement.textContent = totalLossCount;
            if (lossAmountValueElement) lossAmountValueElement.textContent = formatCurrency(totalLossAmount);
        }


        // *** Function to create a chart configuration (reusable) ***
        function createMonthlyChartConfig(chartData, colors, chartId) { // Added chartId parameter
            const months = chartData.map(m => m.monthYear);
            const counts = chartData.map(m => m.count || 0);
            const amounts = chartData.map(m => m.totalAmount || 0);

            // Theme-dependent colors
            const gridColor = getComputedStyle(document.documentElement).getPropertyValue('--chart-grid-color').trim();
            const tickColor = getComputedStyle(document.documentElement).getPropertyValue('--chart-tick-color').trim();
            const titleColor = getComputedStyle(document.documentElement).getPropertyValue('--chart-title-color').trim();
            const legendColor = getComputedStyle(document.documentElement).getPropertyValue('--chart-legend-color').trim();
            const tooltipBgColor = getComputedStyle(document.documentElement).getPropertyValue('--chart-tooltip-bg').trim();
            const tooltipTextColor = getComputedStyle(document.documentElement).getPropertyValue('--chart-tooltip-text').trim();

            const config = {
                type: 'bar',
                data: {
                    labels: months,
                    datasets: [
                        {
                            label: 'Amount',
                            data: amounts,
                            backgroundColor: colors.amountBg,
                            borderColor: colors.amountBorder,
                            borderWidth: 1,
                            yAxisID: 'yAmount',
                            type: 'bar',
                            order: 2
                        },
                        {
                            label: 'Count',
                            data: counts,
                            borderColor: colors.countBorder,
                            backgroundColor: 'rgba(0,0,0,0)', // Transparent fill for line
                            borderWidth: 2,
                            fill: false,
                            tension: 0.1,
                            yAxisID: 'yCount',
                            type: 'line',
                            order: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    plugins: {
                        tooltip: {
                            backgroundColor: tooltipBgColor,
                            titleColor: tooltipTextColor,
                            bodyColor: tooltipTextColor,
                            callbacks: {
                                label: function(ctx) {
                                    let label = ctx.dataset.label || '';
                                    if (label) label += ': ';
                                    if (ctx.dataset.label === 'Amount') {
                                        label += formatCurrency(ctx.parsed.y);
                                    } else {
                                         label += ctx.parsed.y;
                                    }
                                    return label;
                                }
                            }
                        },
                        legend: { position: 'top', labels: { color: legendColor } }
                    },
                    scales: {
                        x: {
                            ticks: { color: tickColor },
                            grid: { color: gridColor, drawOnChartArea: false },
                            title: { display: false, color: titleColor }
                        },
                        yAmount: { // Amount Axis (Left)
                            beginAtZero: true,
                            title: { display: true, text: 'Amount (₱)', color: titleColor },
                            position: 'left',
                            ticks: { color: tickColor, callback: value => formatCurrency(value) },
                            grid: { color: gridColor }
                        },
                        yCount: { // Count Axis (Right)
                            beginAtZero: true,
                            title: { display: true, text: 'Count', color: titleColor },
                            position: 'right',
                            ticks: {
                                color: tickColor,
                                stepSize: 1, precision: 0,
                                callback: function(value) {if (Number.isInteger(value)) {return value;}}
                            },
                            grid: { drawOnChartArea: false } // No grid lines for secondary axis
                        }
                    }
                }
            };

            // Remove onClick handler as it's not needed for Win/Loss charts with filters
            delete config.options.onClick;

            return config; // Return the generated config
        }


        // --- Main Rendering Function ---
        function renderDashboard(data) { // Accepts the (potentially filtered and summarized) data object
            if (!data) {
                 console.error("No data provided to renderDashboard");
                 return;
            }

            updateSummaryCards(data); // Update the 4 summary cards

            // Get theme colors for charts
            const winAmountColor = getComputedStyle(document.documentElement).getPropertyValue('--color-win-cost').trim();
            const winAmountBgColor = getComputedStyle(document.documentElement).getPropertyValue('--color-win-cost-bg').trim();
            const winCountColor = getComputedStyle(document.documentElement).getPropertyValue('--color-win').trim();

            const lossAmountColor = getComputedStyle(document.documentElement).getPropertyValue('--color-loss-cost').trim();
            const lossAmountBgColor = getComputedStyle(document.documentElement).getPropertyValue('--color-loss-cost-bg').trim();
            const lossCountColor = getComputedStyle(document.documentElement).getPropertyValue('--color-loss').trim();


            // --- Render Win Chart ---
            const winChartCanvas = document.getElementById('winMonthlyChart');
            if (winChartCanvas) {
                const winChartConfig = createMonthlyChartConfig(
                    data.op100MonthlySummary || [], // Use summary from passed data
                    { amountBg: winAmountBgColor, amountBorder: winAmountColor, countBorder: winCountColor },
                    'winMonthlyChart' // Pass ID
                );
                if (winChartInstance) winChartInstance.destroy();
                winChartInstance = new Chart(winChartCanvas.getContext('2d'), winChartConfig);
            } else { console.error("Canvas element #winMonthlyChart not found!"); }

            // --- Render Loss Chart ---
            const lossChartCanvas = document.getElementById('lossMonthlyChart');
            if (lossChartCanvas) {
                 const lossData = data.opLossMonthlySummary || []; // Use summary from passed data
                 if (lossData.length > 0) {
                     const lossChartConfig = createMonthlyChartConfig(
                         lossData,
                         { amountBg: lossAmountBgColor, amountBorder: lossAmountColor, countBorder: lossCountColor },
                         'lossMonthlyChart' // Pass ID
                     );
                     if (lossChartInstance) lossChartInstance.destroy();
                     lossChartInstance = new Chart(lossChartCanvas.getContext('2d'), lossChartConfig);
                 } else {
                     console.log("No loss data to display in the loss chart.");
                     if (lossChartInstance) lossChartInstance.destroy();
                     const ctx = lossChartCanvas.getContext('2d');
                     ctx.clearRect(0, 0, lossChartCanvas.width, lossChartCanvas.height);
                     ctx.textAlign = 'center';
                     ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--text-secondary').trim();
                     ctx.fillText('No Loss Data Available', lossChartCanvas.width / 2, lossChartCanvas.height / 2);
                 }
            } else { console.error("Canvas element #lossMonthlyChart not found!"); }

            // --- Render Opportunities Table ---
            renderOpportunitiesTable(dashboardDataCache.opportunities);
        }

        // --- Theme Toggle ---
        function applyTheme(theme) {
            const isDark = theme === 'dark';
            document.documentElement.classList.toggle('dark', isDark);
            const themeIcon = document.getElementById('themeIcon');
            if (themeIcon) {
                themeIcon.textContent = isDark ? 'nights_stay' : 'light_mode';
            }
            const logo = document.getElementById('logo');
            if (logo) {
                 logo.src = isDark ? 'Logo/CMRP Logo Light.svg' : 'Logo/CMRP Logo Dark.svg';
                 logo.onerror = () => { logo.src = `https://placehold.co/100x30/${isDark ? 'e0e0e0/1f2937' : '1f2937/e0e0e0'}?text=CMRP+Logo`; };
            }
            // Re-render dashboard with current filters on theme change
            if (dashboardDataCache) {
                applyFiltersAndRender();
            }
        }

        function toggleTheme() {
            const currentTheme = document.documentElement.classList.contains('dark') ? 'dark' : 'light';
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            localStorage.setItem('theme', newTheme);
            applyTheme(newTheme);
        }

         // *** ADDED: Function to populate solution filter dropdown ***
        function populateFilterDropdowns(data) {
            const solutionSelect = document.getElementById('solutionFilter');
            if (!solutionSelect || !data || !data.uniqueSolutions) {
                console.warn("Could not populate solution filter.");
                return;
            }

            const currentVal = solutionSelect.value; // Preserve selection if possible
            solutionSelect.innerHTML = '<option value="all">All Solutions</option>'; // Reset
            data.uniqueSolutions.forEach(solution => {
                const option = document.createElement('option');
                option.value = solution;
                option.textContent = solution;
                solutionSelect.appendChild(option);
            });
            // Try to restore previous selection, default to 'all' if not possible
            solutionSelect.value = data.uniqueSolutions.includes(currentVal) ? currentVal : 'all';
        }

        // *** ADDED: Function to apply filters and re-render ***
        function applyFiltersAndRender() {
            if (!dashboardDataCache) {
                console.log("Waiting for initial data fetch...");
                return;
            }
            console.log(`Applying filters. Solution: ${currentSolutionFilter}`);
            const filteredData = filterAndSummarizeData(dashboardDataCache, currentSolutionFilter);
            renderDashboard(filteredData);
            renderOpportunitiesTable(dashboardDataCache.opportunities);
        }

        // *** ADDED: Function to set up filter event listeners ***
        function setupFilterListeners() {
            const solutionSelect = document.getElementById('solutionFilter');
            if (solutionSelect) {
                solutionSelect.addEventListener('change', function() {
                    currentSolutionFilter = this.value;
                    applyFiltersAndRender(); // Re-filter and render on change
                });
            }
            // Add listeners for other filters here if needed
        }

        // --- Add Account Manager filter logic and OP100/LOST filter logic ---
        let currentAccountMgrFilter = 'all';
        let currentStatusFilter = 'all';
        let currentClientFilter = 'all';
        function populateAccountMgrDropdown(data) {
            const dropdown = document.getElementById('accountMgrFilter');
            if (!dropdown) return;
            const mgrs = (data.opportunities || []).map(opp => opp['account_mgr']).filter(Boolean);
            const uniqueMgrs = Array.from(new Set(mgrs)). sort();
            dropdown.innerHTML = '<option value="all">All</option>';
            uniqueMgrs.forEach(mgr => {
                const opt = document.createElement('option');
                opt.value = mgr;
                opt.textContent = mgr;
                dropdown.appendChild(opt);
            });
            dropdown.value = currentAccountMgrFilter;
        }
        function populateClientDropdown(data) {
            const dropdown = document.getElementById('clientFilter');
            if (!dropdown) return;
            const clients = (data.opportunities || []).map(opp => opp['client']).filter(Boolean);
            const uniqueClients = Array.from(new Set(clients)).sort();
            dropdown.innerHTML = '<option value="all">All</option>';
            uniqueClients.forEach(client => {
                const opt = document.createElement('option');
                opt.value = client;
                opt.textContent = client;
                dropdown.appendChild(opt);
            });
            dropdown.value = currentClientFilter;
        }
        function applyFiltersAndRender() {
            if (!dashboardDataCache) {
                console.log("Waiting for initial data fetch...");
                return;
            }
            let filteredForGraph = dashboardDataCache.opportunities;
            if (currentSolutionFilter !== 'all') {
                filteredForGraph = filteredForGraph.filter(opp => opp['solutions'] === currentSolutionFilter);
            }
            if (currentAccountMgrFilter !== 'all') {
                filteredForGraph = filteredForGraph.filter(opp => opp['account_mgr'] === currentAccountMgrFilter);
            }
            if (currentClientFilter !== 'all') {
                filteredForGraph = filteredForGraph.filter(opp => opp['client'] === currentClientFilter);
            }
            const filteredData = filterAndSummarizeData({ ...dashboardDataCache, opportunities: filteredForGraph }, currentSolutionFilter);
            renderDashboard(filteredData);
            renderOpportunitiesTable(dashboardDataCache.opportunities);
        }
        document.addEventListener('DOMContentLoaded', () => {
            // Get references to ALL card elements
            op100CountTitleElement = document.getElementById('op100-total-count-title');
            op100AmountTitleElement = document.getElementById('op100-total-amount-title');
            op100CountValueElement = document.getElementById('op100-total-count');
            op100AmountValueElement = document.getElementById('op100-total-amount');
            lossCountTitleElement = document.getElementById('loss-total-count-title');
            lossAmountTitleElement = document.getElementById('loss-total-amount-title');
            lossCountValueElement = document.getElementById('loss-total-count');
            lossAmountValueElement = document.getElementById('loss-total-amount');

            // Set initial theme
            const savedTheme = localStorage.getItem('theme');
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            const initialTheme = savedTheme || (prefersDark ? 'dark' : 'light');
            applyTheme(initialTheme);

            // Add theme toggle listener
            const themeToggleButton = document.getElementById('themeToggleButton');
            if(themeToggleButton) {
               themeToggleButton.addEventListener('click', toggleTheme);
            }

            // Fetch initial data, populate filters, setup listeners, and render
            fetchDashboardData().then(data => {
                 if (data) {
                     populateFilterDropdowns(data); // Populate dropdowns first
                     populateAccountMgrDropdown(data);
                     populateClientDropdown(data);
                     setupFilterListeners();       // Then setup listeners
                     // Add Account Manager filter listener
                     const mgrDropdown = document.getElementById('accountMgrFilter');
                     if (mgrDropdown) {
                         mgrDropdown.addEventListener('change', function() {
                             currentAccountMgrFilter = this.value;
                             applyFiltersAndRender();
                         });
                     }
                     // Add Client filter listener
                     const clientDropdown = document.getElementById('clientFilter');
                     if (clientDropdown) {
                         clientDropdown.addEventListener('change', function() {
                             currentClientFilter = this.value;
                             applyFiltersAndRender();
                         });
                     }
                     // Add OP100/LOST/All filter listeners
                     document.getElementById('filterOP100Btn').onclick = function() {
                         currentTableStatusFilter = 'OP100';
                         setStatusFilterActive('filterOP100Btn');
                         renderOpportunitiesTable(dashboardDataCache.opportunities);
                     };
                     document.getElementById('filterLOSTBtn').onclick = function() {
                         currentTableStatusFilter = 'LOST';
                         setStatusFilterActive('filterLOSTBtn');
                         renderOpportunitiesTable(dashboardDataCache.opportunities);
                     };
                     document.getElementById('filterAllBtn').onclick = function() {
                         currentTableStatusFilter = 'all';
                         setStatusFilterActive('filterAllBtn');
                         renderOpportunitiesTable(dashboardDataCache.opportunities);
                     };
                     applyFiltersAndRender();      // Then apply initial filters and render
                     setStatusFilterActive('filterOP100Btn');
                 } else {
                     console.error("Initial data fetch failed.");
                     // Display error message on page?
                     updateSummaryCards(null); // Clear cards on error
                     // Optionally display error on charts
                     const winCtx = document.getElementById('winMonthlyChart')?.getContext('2d');
                     const lossCtx = document.getElementById('lossMonthlyChart')?.getContext('2d');
                     [winCtx, lossCtx].forEach(ctx => {
                         if (ctx) {
                            ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
                            ctx.textAlign = 'center';
                            ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--text-error').trim();
                            ctx.fillText('Error loading chart data', ctx.canvas.width / 2, ctx.canvas.height / 2);
                         }
                     });
                 }
            });
            // Table filter button listeners (fix: always set correct active state and re-render table)
            document.getElementById('filterOP100Btn').onclick = function() {
                currentTableStatusFilter = 'OP100';
                setStatusFilterActive('filterOP100Btn');
                renderOpportunitiesTable(dashboardDataCache.opportunities);
            };
            document.getElementById('filterLOSTBtn').onclick = function() {
                currentTableStatusFilter = 'LOST';
                setStatusFilterActive('filterLOSTBtn');
                renderOpportunitiesTable(dashboardDataCache.opportunities);
            };
            document.getElementById('filterAllBtn').onclick = function() {
                currentTableStatusFilter = 'all';
                setStatusFilterActive('filterAllBtn');
                renderOpportunitiesTable(dashboardDataCache.opportunities);
            };
            // Set default table filter button active on load
            setStatusFilterActive('filterOP100Btn');
            renderOpportunitiesTable(dashboardDataCache ? dashboardDataCache.opportunities : []);
        });
        function setStatusFilterActive(activeId) {
            ['filterOP100Btn','filterLOSTBtn','filterAllBtn'].forEach(id => {
                const btn = document.getElementById(id);
                if (btn) btn.classList.toggle('active', id === activeId);
            });
        }

        // --- Table filter logic ---
        let currentTableStatusFilter = 'OP100'; // Default to OP100 only
        function applyTableFilters(opportunities) {
            let filtered = opportunities;
            if (currentSolutionFilter !== 'all') {
                filtered = filtered.filter(opp => opp['solutions'] === currentSolutionFilter);
            }
            if (currentAccountMgrFilter !== 'all') {
                filtered = filtered.filter(opp => opp['account_mgr'] === currentAccountMgrFilter);
            }
            if (currentClientFilter !== 'all') {
                filtered = filtered.filter(opp => opp['client'] === currentClientFilter);
            }
            if (currentTableStatusFilter === 'OP100') {
                filtered = filtered.filter(opp => (opp['opp_status']||'').toUpperCase() === 'OP100');
            } else if (currentTableStatusFilter === 'LOST') {
                filtered = filtered.filter(opp => (opp['opp_status']||'').toUpperCase() === 'LOST');
            }
            return filtered;
        }
        function renderOpportunitiesTable(opportunities) {
            const tableBody = document.getElementById('opportunitiesTableBody');
            if (!tableBody) return;
            tableBody.innerHTML = '';
            const filtered = applyTableFilters(opportunities);
            filtered.forEach((opp, index) => {
                const tr = document.createElement('tr');
                const projectName = opp['opp_name'] || opp['project_name'] || '';
                const client = opp['client'] || '';
                const acctMgr = opp['account_mgr'] || '';
                // --- Fix: Awarded Date should be shifted +1 month, and use UTC ---
                let dateAwarded = '';
                if (opp['date_awarded_lost']) {
                    const d = new Date(opp['date_awarded_lost']);
                    if (!isNaN(d)) {
                        let year = d.getUTCFullYear();
                        let month = d.getUTCMonth() + 1; // 0-based, so +1
                        if (month > 11) { year += 1; month = 0; }
                        const shifted = new Date(Date.UTC(year, month, 1));
                        dateAwarded = shifted.toLocaleDateString('en-US', { month: 'long', year: 'numeric', timeZone: 'UTC' });
                    }
                }
                const finalAmtValue = opp['final_amt'] || '';
                const marginValue = opp['margin_percentage'] || opp['margin'] || '';
                tr.innerHTML = `
                    <td class="project-name-cell px-4 py-2 whitespace-normal text-sm text-gray-900 dark:text-gray-100">${projectName}</td>
                    <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-900 dark:text-gray-100">${client}</td>
                    <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-900 dark:text-gray-100">${acctMgr}</td>
                    <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-900 dark:text-gray-100">${formatDateAwardedMDY(opp['date_awarded_lost'])}</td>
                    <td class="px-4 py-2 whitespace-nowrap text-sm text-right text-gray-900 dark:text-gray-100">${formatCurrency(finalAmtValue)}</td>
                    <td class="px-4 py-2 whitespace-nowrap text-sm text-right text-gray-900 dark:text-gray-100">${formatMargin(marginValue)}</td>
                `;
                tableBody.appendChild(tr);
            });
        }

        // Add this helper function (temporary)
        function formatDateAwardedMDY(dateString) {
            if (!dateString) return '';
            const d = new Date(dateString);
            if (isNaN(d)) return dateString;
            // Example: May 4, 2024
            return d.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });
        }

        function parseLocalDate(dateString) {
            // Handles "YYYY-MM-DD" and "YYYY-MM-DDTHH:MM:SSZ"
            if (!dateString) return null;
            if (/^\d{4}-\d{2}-\d{2}$/.test(dateString)) {
                // "YYYY-MM-DD" (treat as local)
                const [year, month, day] = dateString.split('-').map(Number);
                return new Date(year, month - 1, day);
            }
            // If ISO string, remove 'Z' to force local
            if (dateString.endsWith('Z')) {
                return new Date(dateString.replace(/Z$/, ''));
            }
            // Fallback
            return new Date(dateString);
        }

        // When grouping for the chart:
        const monthCounts = {};
        opportunities.forEach(opp => {
            const dateStr = opp['Date Awarded'];
            const date = parseLocalDate(dateStr);
            if (!date || isNaN(date)) return;
            // Use local year/month
            const year = date.getFullYear();
            const month = date.getMonth(); // 0=Jan
            const key = `${year}-${String(month + 1).padStart(2, '0')}`;
            monthCounts[key] = (monthCounts[key] || 0) + 1;
        });
        </script>
    </div>
    <script src="js/scripts.js"></script>
    <script>
        // --- Logo Theme Switcher ---
        function updateLogoForTheme() {
            const logo = document.getElementById('cmrpLogo');
            const isDark = document.documentElement.classList.contains('dark');
            logo.src = isDark ? 'Logo/CMRP Logo Light.svg' : 'Logo/CMRP Logo Dark.svg';
        }
        updateLogoForTheme();
        const themeToggle = document.getElementById('themeToggle');
        themeToggle.addEventListener('click', function() {
            document.documentElement.classList.toggle('dark');
            setTimeout(updateLogoForTheme, 10);
        });
        const observer = new MutationObserver(updateLogoForTheme);
        observer.observe(document.documentElement, { attributes: true, attributeFilter: ['class'] });
    </script>
</body>
</html>
