<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' https://cdn.jsdelivr.net https://cdn.tailwindcss.com https://cdn.sheetjs.com https://cdnjs.cloudflare.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://cdn.tailwindcss.com; font-src 'self' https://fonts.gstatic.com; img-src 'self' data:; connect-src 'self' https://cmrp-opps-backend.onrender.com;">
    <title>2025 Opportunities Management (Filters Added)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.2/package/dist/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
    <link rel="stylesheet" href="styles.css">
    <script src="config.js"></script>
    <script src="app.js" defer></script>
</head>
<body>
    <nav class="sidebar">
        <!-- Sidebar content -->
    </nav>
    <div class="main-content">
        <div class="simple-header">
            <div class="title-group">
                <a href="index.html" title="Go to Home" style="text-decoration: none; color: inherit;">
                    <img id="cmrpLogo" src="Logo/CMRP Logo Light.svg" alt="CMRP Logo" style="height:2.2rem;width:auto;display:inline-block;vertical-align:middle;transition:filter 0.2s;cursor:pointer;" />
                </a>
                <span class="subtitle">2025 Opportunities Management</span>
            </div>
            <div class="flex items-center gap-2">
                <nav class="flex gap-2" id="mainNav">
                    <a href="index.html" class="nav-square-btn active" title="Opportunities Management - View and manage all opportunities"><span class="material-icons">dashboard</span></a>
                    <a href="win-loss_dashboard.html" class="nav-square-btn" title="Win-Loss Dashboard - Analyze won and lost opportunities"><span class="material-icons">line_axis</span></a>
                    <a href="forecastr_dashboard.html" class="nav-square-btn" title="Forecast Dashboard - View revenue forecasts and trends"><span class="material-icons">insights</span></a>
                    <a href="executive_dashboard.html" class="nav-square-btn" title="Executive Dashboard - Comprehensive business metrics"><span class="material-icons">analytics</span></a>
                    <a href="user_management.html" class="nav-square-btn" id="userMgmtNavBtn" title="User Management - Manage users and permissions (Admin only)"><span class="material-icons">group</span></a>
                </nav>
                <button id="themeToggle" class="nav-square-btn" title="Toggle between light and dark theme"><span class="material-icons">light_mode</span></button>
                <button id="changePasswordBtn" class="nav-square-btn" title="Change your account password"><span class="material-icons">lock</span></button>
                <button id="logoutBtn" class="nav-square-btn" title="Sign out of your account"><span class="material-icons">logout</span></button>
            </div>
        </div>
        <div class="container mx-auto p-6 rounded-lg shadow-md border">
            <!-- Removed old header block: div.flex.justify-between.items-center.mb-6 -->

            <div class="mb-4">
                <input id="searchInput" type="text" placeholder="Search all fields..." class="w-full p-2 border rounded" />
            </div>

            <!-- Delta Comparison Toggle -->
            <div class="mb-4 flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <label class="text-sm font-medium text-gray-700 dark:text-gray-300">Show changes from:</label>
                    <div class="dashboard-toggle-container">
                        <button id="weeklyToggle" class="dashboard-toggle-btn active">
                            Last Week
                        </button>
                        <button id="monthlyToggle" class="dashboard-toggle-btn">
                            Last Month
                        </button>
                        <button id="noCompareToggle" class="dashboard-toggle-btn">
                            No Comparison
                        </button>
                    </div>
                </div>
                <button id="saveSnapshotBtn" class="dashboard-save-snapshot-btn" title="Save current data as snapshot">
                    Save Snapshot
                </button>
            </div>

            <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4 mb-6">
                <div id="totalOpportunitiesCard" class="dashboard-card cursor-pointer" title="Show monthly trend">
                    <div class="dashboard-title">Total Opportunities</div>
                    <div id="totalOpportunities" class="dashboard-value">--</div>
                </div>
                <div class="dashboard-card">
                    <div class="dashboard-title">Total Submitted</div>
                    <div id="totalSubmitted" class="dashboard-value">--</div>
                </div>
                <div class="dashboard-card">
                    <div class="dashboard-title">OP100 (Count / Amount)</div>
                    <div id="op100Summary" class="dashboard-value">--</div>
                </div>
                <div class="dashboard-card">
                    <div class="dashboard-title">OP90 (Count / Amount)</div>
                    <div id="op90Summary" class="dashboard-value">--</div>
                </div>
                <div class="dashboard-card">
                    <div class="dashboard-title">Total Declined</div>
                    <div id="totalDeclined" class="dashboard-value">--</div>
                </div>
                <div class="dashboard-card">
                    <div class="dashboard-title">Total Inactive</div>
                    <div id="totalInactive" class="dashboard-value">--</div>
                </div>
            </div>

            <div class="mb-4">
                <div class="flex flex-wrap gap-2 items-center mb-2" id="statusFilterButtons">
                    <span class="text-sm font-medium mr-2">Filter by Status:</span>
                    <button data-filter-type="status" data-filter-value="all" class="filter-button px-3 py-1 rounded text-xs active">All</button>
                    <button data-filter-type="status" data-filter-value="op100" class="filter-button px-3 py-1 rounded text-xs">OP100</button>
                    <button data-filter-type="status" data-filter-value="op90" class="filter-button px-3 py-1 rounded text-xs">OP90</button>
                    <button data-filter-type="status" data-filter-value="op60" class="filter-button px-3 py-1 rounded text-xs">OP60</button>
                    <button data-filter-type="status" data-filter-value="op30" class="filter-button px-3 py-1 rounded text-xs">OP30</button>
                    <button data-filter-type="status" data-filter-value="submitted" class="filter-button px-3 py-1 rounded text-xs">Submitted</button>
                    <button data-filter-type="status" data-filter-value="ongoing" class="filter-button px-3 py-1 rounded text-xs">On-Going</button>
                    <button data-filter-type="status" data-filter-value="not_yet_started" class="filter-button px-3 py-1 rounded text-xs">Not Yet Started</button>
                    <button data-filter-type="status" data-filter-value="no_decision" class="filter-button px-3 py-1 rounded text-xs">No Decision Yet</button>
                    <button data-filter-type="status" data-filter-value="lost" class="filter-button px-3 py-1 rounded text-xs">Lost</button>
                    <button data-filter-type="status" data-filter-value="declined" class="filter-button px-3 py-1 rounded text-xs">Declined</button>
                    <button data-filter-type="status" data-filter-value="inactive" class="filter-button px-3 py-1 rounded text-xs">Inactive</button>
                </div>
                 <div class="flex flex-wrap gap-4 items-center">
                     <div>
                         <label for="accountMgrFilter" class="text-sm font-medium mr-1">Account Mgr:</label>
                         <select id="accountMgrFilter" data-filter-type="accountMgr" class="filter-dropdown p-1 text-xs rounded border">
                             <option value="all">All</option>
                             </select>
                     </div>
                     <div>
                         <label for="picFilter" class="text-sm font-medium mr-1">PIC:</label>
                         <select id="picFilter" data-filter-type="pic" class="filter-dropdown p-1 text-xs rounded border">
                             <option value="all">All</option>
                             </select>
                     </div>
                 </div>
            </div>

            <div class="flex flex-wrap gap-2 mb-4">
                <button id="createOpportunityButton" class="action-button px-3 py-2 rounded flex items-center justify-center" title="Add New Opportunity - Create a new opportunity record"><span class="material-icons">add</span></button>
                <button id="toggleColumnsButton" class="theme-button px-3 py-1 rounded flex items-center justify-center" title="Toggle Column Visibility - Show/hide table columns"><span class="material-icons">view_column</span></button>
                <button id="exportExcelButton" class="theme-button px-3 py-1 rounded flex items-center justify-center" title="Download Excel - Export visible data to Excel file"><span class="material-icons">download</span></button>
                <button id="clearFilterButton" class="theme-button px-3 py-1 rounded flex items-center justify-center" title="Clear All Filters - Reset all applied filters and search"><span class="material-icons">filter_alt_off</span><span class="ml-1"></span></button>
            </div>
            <div id="columnToggleContainer" class="hidden grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-x-4 gap-y-2 mb-4 p-4 border rounded">
                 </div>


            <div class="table-responsive-wrapper">
                <div class="table-container">
                    <table id="opportunitiesTable" class="min-w-full divide-y">
                        <thead class="sticky-header"></thead>
                        <tbody class="">
                            <tr><td colspan="100%" class="text-center p-4 loading-text">Loading data...</td></tr>
                        </tbody>
                    </table>
                </div>
                <div class="scroll-indicator">Scroll horizontally to see more columns →</div>
            </div>
            <div id="rowCount" class="mt-4 text-sm"></div>
            
            <div id="loadingText" class="loading-text text-center p-4" style="display: none;">Loading data...</div>
        </div>

        <div id="remarksModalOverlay" class="modal-overlay hidden">
            <div id="remarksModal" class="modal hidden" style="max-width: 800px; max-height: 80vh;">
                <button type="button" aria-label="Close" class="modal-close-x">&times;</button>
                <h2>Edit Remarks / Comments</h2>
                <textarea id="remarksTextarea" style="width: 100%; min-height: 400px; padding: 1rem; margin: 1rem 0; font-family: inherit; border: 1px solid var(--border-color); border-radius: 4px;"></textarea>
                <div class="modal-actions">
                    <button id="closeModalButton" class="modal-close-btn" type="button">Cancel</button>
                    <button id="saveRemarksButton" class="modal-save-btn" type="button">Save</button>
                </div>
            </div>
        </div>

        <div id="editRowModalOverlay" class="modal-overlay hidden">
            <div id="editRowModal" class="modal">
                <div class="modal-header">
                    <h2>Edit Row</h2>
                    <button id="editRowModalCloseX" type="button" aria-label="Close" class="modal-close-x">
                        <span class="material-icons">close</span>
                    </button>
                </div>
                <form id="editRowForm" class="modal-body"> </form>
                <div class="modal-actions">
                    <button id="closeEditRowModalButton" class="modal-close-btn" type="button">Cancel</button>
                    <button id="saveEditRowButton" class="modal-save-btn" type="submit" form="editRowForm">Save</button>
                </div>
            </div>
        </div>

        <!-- Revision History Modal -->
        <div id="revisionHistoryModalOverlay" class="modal-overlay hidden"></div>
        <div id="revisionHistoryModal" class="modal hidden">
            <button type="button" aria-label="Close" onclick="hideRevisionHistoryModal()" style="position:absolute;top:0.5rem;right:0.5rem;font-size:1.25rem;line-height:1;color:var(--text-secondary);background:transparent;border:none;z-index:10;">&times;</button>
            <h2>Revision History</h2>
            <div id="revisionHistoryContent" class="table-container" style="max-height:60vh;overflow:auto;">
                <table class="min-w-full divide-y">
                    <thead>
                        <tr>
                            <th class="px-3 py-2 bg-header text-left">Revision #</th>
                            <th class="px-3 py-2 bg-header text-left">Changed By</th>
                            <th class="px-3 py-2 bg-header text-left">Changed At</th>
                            <th class="px-3 py-2 bg-header text-left">Field</th>
                            <th class="px-3 py-2 bg-header text-left">Old Value</th>
                            <th class="px-3 py-2 bg-header text-left">New Value</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td colspan="6" class="text-center p-4 loading-text">Loading revision history...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div class="modal-actions">
                <button id="closeRevisionHistoryButton" class="modal-close-btn" type="button">Close</button>
            </div>
        </div>

        <!-- Modal for Opportunities Line Chart -->
        <div id="oppsChartModalOverlay" class="modal-overlay hidden"></div>
        <div id="oppsChartModal" class="modal hidden">
            <button type="button" aria-label="Close" id="oppsChartModalClose" style="position:absolute;top:0.5rem;right:0.5rem;font-size:1.25rem;line-height:1;color:var(--text-secondary);background:transparent;border:none;cursor:pointer;z-index:10;">&times;</button>
            <h2>Total Opportunities (Monthly Trend)</h2>
            <div id="oppsChartCanvasContainer" style="height:60vh;min-height:320px;max-height:70vh;display:flex;align-items:center;">
                <canvas id="oppsChartCanvas" style="width:100%;height:100%;"></canvas>
            </div>
            <div class="modal-actions">
                <button id="oppsChartModalCloseBtn" class="modal-close-btn" type="button">Close</button>
            </div>
        </div>

        <!-- Create New Opportunity Modal -->
        <div id="createOpportunityModalOverlay" class="modal-overlay hidden">
            <div id="createOpportunityModal" class="modal hidden" style="max-width: 600px;">
                <div class="modal-header">
                    <h2>Create New Opportunity</h2>
                    <button id="createOpportunityModalCloseX" type="button" aria-label="Close" class="modal-close-x">&times;</button>
                </div>
                <form id="createOpportunityForm" class="modal-body">
                    <div class="form-group mb-4">
                        <label for="newProjectName">Project Name</label>
                        <input type="text" id="newProjectName" name="project_name" class="w-full p-2 border rounded" required />
                    </div>
                    <div class="form-group mb-4">
                        <label for="newClient">Client</label>
                        <input type="text" id="newClient" name="client" class="w-full p-2 border rounded" required />
                    </div>
                    <div class="form-group mb-4">
                        <label for="newSolution">Solution</label>
                        <input type="text" id="newSolution" name="solution" class="w-full p-2 border rounded" />
                    </div>
                    <div class="form-group mb-4">
                        <label for="newIndustry">Industry</label>
                        <input type="text" id="newIndustry" name="industry" class="w-full p-2 border rounded" />
                    </div>
                    <div class="form-group mb-4">
                        <label for="newProposalDueDate">Proposal Due Date</label>
                        <input type="date" id="newProposalDueDate" name="proposal_due_date" class="w-full p-2 border rounded" />
                    </div>
                    <div class="form-group mb-4">
                        <label for="newDecisionDueDate">Decision Due Date</label>
                        <input type="date" id="newDecisionDueDate" name="decision_due_date" class="w-full p-2 border rounded" />
                    </div>
                    <div class="form-group mb-4">
                        <label for="newDecision">Decision <span class="dropdown-arrow">&#9662;</span></label>
                        <select id="newDecision" name="decision" class="w-full p-2 border rounded dropdown-field">
                            <option value="">-- Select --</option>
                            <option value="GO">GO</option>
                            <option value="DECLINE">DECLINE</option>
                            <option value="Pending">Pending</option>
                        </select>
                    </div>
                    <div class="form-group mb-4">
                        <label for="newAccountMgr">Account Manager</label>
                        <input type="text" id="newAccountMgr" name="account_mgr" class="w-full p-2 border rounded" />
                    </div>
                    <div class="form-group mb-4">
                        <label for="newPIC">PIC</label>
                        <input type="text" id="newPIC" name="pic" class="w-full p-2 border rounded" />
                    </div>
                    <div class="form-group mb-4">
                        <label for="newBOM">BOM</label>
                        <input type="text" id="newBOM" name="bom" class="w-full p-2 border rounded" />
                    </div>
                    <div class="form-group mb-4">
                        <label for="newStatus">Status <span class="dropdown-arrow">&#9662;</span></label>
                        <select id="newStatus" name="status" class="w-full p-2 border rounded dropdown-field">
                            <option value="">-- Select --</option>
                            <option value="On-Going">On-Going</option>
                            <option value="For Revision">For Revision</option>
                            <option value="For Approval">For Approval</option>
                            <option value="Submitted">Submitted</option>
                            <option value="No Decision Yet">No Decision Yet</option>
                            <option value="Not Yet Started">Not Yet Started</option>
                        </select>
                    </div>
                    <div class="form-group mb-4">
                        <label for="newSubmitted">Submitted <span class="dropdown-arrow">&#9662;</span></label>
                        <select id="newSubmitted" name="submitted" class="w-full p-2 border rounded dropdown-field">
                            <option value="">-- Select --</option>
                            <option value="Yes">Yes</option>
                            <option value="No">No</option>
                        </select>
                    </div>
                    <div class="form-group mb-4">
                        <label for="newMargin">Margin (%)</label>
                        <input type="number" id="newMargin" name="margin" class="w-full p-2 border rounded" step="0.01" />
                    </div>
                    <div class="form-group mb-4">
                        <label for="newFinalAmount">Final Amount</label>
                        <input type="number" id="newFinalAmount" name="final_amount" class="w-full p-2 border rounded" step="0.01" />
                    </div>
                    <div class="form-group mb-4">
                        <label for="newOppStatus">Opportunity Status <span class="dropdown-arrow">&#9662;</span></label>
                        <select id="newOppStatus" name="opp_status" class="w-full p-2 border rounded dropdown-field">
                            <option value="">-- Select --</option>
                            <option value="OP100">OP100</option>
                            <option value="OP90">OP90</option>
                            <option value="OP60">OP60</option>
                            <option value="OP30">OP30</option>
                            <option value="Inactive">Inactive</option>
                        </select>
                    </div>
                    <div class="form-group mb-4">
                        <label for="newDateAwarded">Date Awarded/Lost</label>
                        <input type="date" id="newDateAwarded" name="date_awarded" class="w-full p-2 border rounded" />
                    </div>
                    <div class="form-group mb-4">
                        <label for="newRemarksComments">Remarks / Comments</label>
                        <textarea id="newRemarksComments" name="remarks_comments" class="w-full p-2 border rounded" rows="3"></textarea>
                    </div>
                    <div class="form-group mb-4">
                        <label for="newForecastDate">Forecast Date</label>
                        <input type="date" id="newForecastDate" name="forecast_date" class="w-full p-2 border rounded" />
                    </div>
                </form>
                <div class="modal-actions">
                    <button id="closeCreateOpportunityModalButton" class="modal-close-btn" type="button">Cancel</button>
                    <button id="saveCreateOpportunityButton" class="modal-save-btn" type="submit" form="createOpportunityForm">Create</button>
                </div>
            </div>
        </div>
    </div>
    <div id="authModalOverlay" class="auth-modal-overlay" style="display:none;"></div>
    <div id="authModal" class="auth-modal" style="display:none;">
        <div class="auth-modal-logo">
            <img src="Logo/CMRP Logo Dark.svg" alt="CMRP Logo" class="modal-logo" />
        </div>
        <h2 id="authModalTitle">Login</h2>
        <form id="authForm">
            <div class="error-text" id="authError" style="display:none;"></div>
            <div class="success-text" id="authSuccess" style="display:none;"></div>
            <label>Email
                <input type="email" id="authEmail" required autocomplete="username" />
            </label>
            <label>Password
                <input type="password" id="authPassword" required autocomplete="current-password" />
            </label>
            <div id="registerFields" style="display:none;">
                <label>Name
                    <input type="text" id="authName" autocomplete="name" />
                </label>
                <div class="roles-group">
                    <span>Department/Role:</span><br>
                    <label><input type="checkbox" name="role" value="technical"> Technical</label>
                    <label><input type="checkbox" name="role" value="proposal"> Proposal</label>
                    <label><input type="checkbox" name="role" value="sales"> Sales</label>
                </div>
            </div>
            <button type="submit" id="authSubmitBtn" class="theme-button w-full">Login</button>
        </form>
        <span id="switchAuthMode" class="switch-link">Don't have an account? Register</span>
    </div>
    <div id="authErrorBanner" style="display:none;color:#fff;background:#d32f2f;padding:1rem;text-align:center;font-weight:bold;"></div>
</body>
</html>